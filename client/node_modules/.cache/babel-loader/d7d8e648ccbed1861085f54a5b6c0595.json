{"ast":null,"code":"'use strict';\n\nvar _slicedToArray = function () {\n  function sliceIterator(arr, i) {\n    var _arr = [];\n    var _n = true;\n    var _d = false;\n    var _e = undefined;\n\n    try {\n      for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n        _arr.push(_s.value);\n\n        if (i && _arr.length === i) break;\n      }\n    } catch (err) {\n      _d = true;\n      _e = err;\n    } finally {\n      try {\n        if (!_n && _i[\"return\"]) _i[\"return\"]();\n      } finally {\n        if (_d) throw _e;\n      }\n    }\n\n    return _arr;\n  }\n\n  return function (arr, i) {\n    if (Array.isArray(arr)) {\n      return arr;\n    } else if (Symbol.iterator in Object(arr)) {\n      return sliceIterator(arr, i);\n    } else {\n      throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n    }\n  };\n}();\n\nvar _createClass = function () {\n  function defineProperties(target, props) {\n    for (var i = 0; i < props.length; i++) {\n      var descriptor = props[i];\n      descriptor.enumerable = descriptor.enumerable || false;\n      descriptor.configurable = true;\n      if (\"value\" in descriptor) descriptor.writable = true;\n      Object.defineProperty(target, descriptor.key, descriptor);\n    }\n  }\n\n  return function (Constructor, protoProps, staticProps) {\n    if (protoProps) defineProperties(Constructor.prototype, protoProps);\n    if (staticProps) defineProperties(Constructor, staticProps);\n    return Constructor;\n  };\n}();\n\nvar _get = function get(object, property, receiver) {\n  if (object === null) object = Function.prototype;\n  var desc = Object.getOwnPropertyDescriptor(object, property);\n\n  if (desc === undefined) {\n    var parent = Object.getPrototypeOf(object);\n\n    if (parent === null) {\n      return undefined;\n    } else {\n      return get(parent, property, receiver);\n    }\n  } else if (\"value\" in desc) {\n    return desc.value;\n  } else {\n    var getter = desc.get;\n\n    if (getter === undefined) {\n      return undefined;\n    }\n\n    return getter.call(receiver);\n  }\n};\n\nfunction _toConsumableArray(arr) {\n  if (Array.isArray(arr)) {\n    for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) {\n      arr2[i] = arr[i];\n    }\n\n    return arr2;\n  } else {\n    return Array.from(arr);\n  }\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (!self) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass);\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      enumerable: false,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;\n}\n\nvar DominantSpeakerSignaling = require('./dominantspeakersignaling');\n\nvar NetworkQualityMonitor = require('./networkqualitymonitor');\n\nvar NetworkQualitySignaling = require('./networkqualitysignaling');\n\nvar RecordingV2 = require('./recording');\n\nvar RoomSignaling = require('../room');\n\nvar RemoteParticipantV2 = require('./remoteparticipant');\n\nvar StatsReport = require('../../stats/statsreport');\n\nvar TrackPrioritySignaling = require('./trackprioritysignaling');\n\nvar TrackSwitchOffSignaling = require('./trackswitchoffsignaling');\n\nvar _require = require('../../util'),\n    createBandwidthProfilePayload = _require.createBandwidthProfilePayload,\n    defer = _require.defer,\n    filterObject = _require.filterObject,\n    flatMap = _require.flatMap,\n    oncePerTick = _require.oncePerTick;\n\nvar _require2 = require('../../util/twilio-video-errors'),\n    createTwilioError = _require2.createTwilioError;\n\nvar STATS_PUBLISH_INTERVAL_MS = 1000;\n/**\n * @extends RoomSignaling\n */\n\nvar RoomV2 = function (_RoomSignaling) {\n  _inherits(RoomV2, _RoomSignaling);\n\n  function RoomV2(localParticipant, initialState, transport, peerConnectionManager, options) {\n    _classCallCheck(this, RoomV2);\n\n    options = Object.assign({\n      DominantSpeakerSignaling: DominantSpeakerSignaling,\n      NetworkQualityMonitor: NetworkQualityMonitor,\n      NetworkQualitySignaling: NetworkQualitySignaling,\n      RecordingSignaling: RecordingV2,\n      RemoteParticipantV2: RemoteParticipantV2,\n      TrackPrioritySignaling: TrackPrioritySignaling,\n      TrackSwitchOffSignaling: TrackSwitchOffSignaling,\n      bandwidthProfile: null,\n      statsPublishIntervalMs: STATS_PUBLISH_INTERVAL_MS\n    }, options);\n    localParticipant.setBandwidthProfile(options.bandwidthProfile);\n\n    var _this = _possibleConstructorReturn(this, (RoomV2.__proto__ || Object.getPrototypeOf(RoomV2)).call(this, localParticipant, initialState.sid, initialState.name, options));\n\n    Object.defineProperties(_this, {\n      _dominantSpeakerSignaling: {\n        value: null,\n        writable: true\n      },\n      _DominantSpeakerSignaling: {\n        value: options.DominantSpeakerSignaling\n      },\n      _dominantSpeakerSignalingPromise: {\n        value: null,\n        writable: true\n      },\n      _disconnectedParticipantSids: {\n        value: new Set()\n      },\n      _NetworkQualityMonitor: {\n        value: options.NetworkQualityMonitor\n      },\n      _NetworkQualitySignaling: {\n        value: options.NetworkQualitySignaling\n      },\n      _lastBandwidthProfileRevision: {\n        value: localParticipant.bandwidthProfileRevision,\n        writable: true\n      },\n      _networkQualityMonitor: {\n        value: null,\n        writable: true\n      },\n      _networkQualityMonitorPromise: {\n        value: null,\n        writable: true\n      },\n      _networkQualityConfiguration: {\n        value: localParticipant.networkQualityConfiguration\n      },\n      _peerConnectionManager: {\n        value: peerConnectionManager\n      },\n      _published: {\n        value: new Map()\n      },\n      _publishedRevision: {\n        value: 0,\n        writable: true\n      },\n      _RemoteParticipantV2: {\n        value: options.RemoteParticipantV2\n      },\n      _subscribed: {\n        value: new Map()\n      },\n      _subscribedRevision: {\n        value: 0,\n        writable: true\n      },\n      _subscriptionFailures: {\n        value: new Map()\n      },\n      _trackPriorityPromise: {\n        value: null,\n        writable: true\n      },\n      _trackPrioritySignaling: {\n        value: null,\n        writable: true\n      },\n      _trackSwitchOffPromise: {\n        value: null,\n        writable: true\n      },\n      _trackSwitchOffSignaling: {\n        value: null,\n        writable: true\n      },\n      _TrackPrioritySignaling: {\n        value: options.TrackPrioritySignaling\n      },\n      _TrackSwitchOffSignaling: {\n        value: options.TrackSwitchOffSignaling\n      },\n      _transport: {\n        value: transport\n      },\n      _trackReceiverDeferreds: {\n        value: new Map()\n      }\n    });\n    handleLocalParticipantEvents(_this, localParticipant);\n    handlePeerConnectionEvents(_this, peerConnectionManager);\n    handleTransportEvents(_this, transport);\n    periodicallyPublishStats(_this, transport, options.statsPublishIntervalMs);\n\n    _this._update(initialState);\n\n    return _this;\n  }\n  /**\n   * The Signaling Connection State\n   * @property {string} - \"connected\", \"reconnecting\", \"disconnected\"\n   */\n\n\n  _createClass(RoomV2, [{\n    key: '_deleteTrackReceiverDeferred',\n\n    /**\n     * @private\n     */\n    value: function _deleteTrackReceiverDeferred(id) {\n      return this._trackReceiverDeferreds.delete(id);\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getOrCreateTrackReceiverDeferred',\n    value: function _getOrCreateTrackReceiverDeferred(id) {\n      var deferred = this._trackReceiverDeferreds.get(id) || defer();\n\n      var trackReceivers = this._peerConnectionManager.getTrackReceivers(); // NOTE(mmalavalli): In Firefox, there can be instances where a MediaStreamTrack\n      // for the given Track ID already exists, for example, when a Track is removed\n      // and added back. If that is the case, then we should resolve 'deferred'.\n\n\n      var trackReceiver = trackReceivers.find(function (trackReceiver) {\n        return trackReceiver.id === id && trackReceiver.readyState !== 'ended';\n      });\n\n      if (trackReceiver) {\n        deferred.resolve(trackReceiver);\n      } else {\n        // NOTE(mmalavalli): Only add the 'deferred' to the map if it's not\n        // resolved. This will prevent old copies of the MediaStreamTrack from\n        // being used when the remote peer removes and re-adds a MediaStreamTrack.\n        this._trackReceiverDeferreds.set(id, deferred);\n      }\n\n      return deferred;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_addTrackReceiver',\n    value: function _addTrackReceiver(trackReceiver) {\n      var deferred = this._getOrCreateTrackReceiverDeferred(trackReceiver.id);\n\n      deferred.resolve(trackReceiver);\n      return this;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_disconnect',\n    value: function _disconnect(error) {\n      var didDisconnect = _get(RoomV2.prototype.__proto__ || Object.getPrototypeOf(RoomV2.prototype), '_disconnect', this).call(this, error);\n\n      if (didDisconnect) {\n        this._teardownDominantSpeakerSignaling();\n\n        this._teardownNetworkQualityMonitor();\n\n        this._transport.disconnect();\n\n        this._peerConnectionManager.close();\n      }\n\n      this.localParticipant.tracks.forEach(function (track) {\n        track.publishFailed(error || new Error('LocalParticipant disconnected'));\n      });\n      return didDisconnect;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getTrackReceiver',\n    value: function _getTrackReceiver(id) {\n      var _this2 = this;\n\n      return this._getOrCreateTrackReceiverDeferred(id).promise.then(function (trackReceiver) {\n        _this2._deleteTrackReceiverDeferred(id);\n\n        return trackReceiver;\n      });\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getTrackSidsToTrackSignalings',\n    value: function _getTrackSidsToTrackSignalings() {\n      var trackSidsToTrackSignalings = flatMap(this.participants, function (participant) {\n        return Array.from(participant.tracks);\n      });\n      return new Map(trackSidsToTrackSignalings);\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getOrCreateRemoteParticipant',\n    value: function _getOrCreateRemoteParticipant(participantState) {\n      var RemoteParticipantV2 = this._RemoteParticipantV2;\n      var participant = this.participants.get(participantState.sid);\n      var self = this;\n\n      if (!participant) {\n        participant = new RemoteParticipantV2(participantState, this._getTrackReceiver.bind(this));\n        participant.on('stateChanged', function stateChanged(state) {\n          if (state === 'disconnected') {\n            participant.removeListener('stateChanged', stateChanged);\n            self.participants.delete(participant.sid);\n\n            self._disconnectedParticipantSids.add(participant.sid);\n          }\n        });\n        this.connectParticipant(participant);\n        participant.setTrackPrioritySignaling(this._trackPrioritySignaling);\n      }\n\n      return participant;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getState',\n    value: function _getState() {\n      return {\n        participant: this.localParticipant.getState()\n      };\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_maybeAddBandwidthProfile',\n    value: function _maybeAddBandwidthProfile(update) {\n      var _localParticipant = this.localParticipant,\n          bandwidthProfile = _localParticipant.bandwidthProfile,\n          bandwidthProfileRevision = _localParticipant.bandwidthProfileRevision;\n\n      if (bandwidthProfile && this._lastBandwidthProfileRevision < bandwidthProfileRevision) {\n        this._lastBandwidthProfileRevision = bandwidthProfileRevision;\n        return Object.assign({\n          bandwidth_profile: createBandwidthProfilePayload(bandwidthProfile)\n        }, update);\n      }\n\n      return update;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_publishNewLocalParticipantState',\n    value: function _publishNewLocalParticipantState() {\n      this._transport.publish(this._maybeAddBandwidthProfile(this._getState()));\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_publishPeerConnectionState',\n    value: function _publishPeerConnectionState(peerConnectionState) {\n      /* eslint camelcase:0 */\n      this._transport.publish(Object.assign({\n        peer_connections: [peerConnectionState]\n      }, this._getState()));\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_update',\n    value: function _update(roomState) {\n      var _this3 = this;\n\n      if (roomState.subscribed && roomState.subscribed.revision > this._subscribedRevision) {\n        this._subscribedRevision = roomState.subscribed.revision;\n        roomState.subscribed.tracks.forEach(function (trackState) {\n          if (trackState.id) {\n            _this3._subscriptionFailures.delete(trackState.sid);\n\n            _this3._subscribed.set(trackState.sid, trackState.id);\n          } else if (trackState.error && !_this3._subscriptionFailures.has(trackState.sid)) {\n            _this3._subscriptionFailures.set(trackState.sid, trackState.error);\n          }\n        });\n        var subscribedTrackSids = new Set(roomState.subscribed.tracks.filter(function (trackState) {\n          return !!trackState.id;\n        }).map(function (trackState) {\n          return trackState.sid;\n        }));\n\n        this._subscribed.forEach(function (trackId, trackSid) {\n          if (!subscribedTrackSids.has(trackSid)) {\n            _this3._subscribed.delete(trackSid);\n          }\n        });\n      }\n\n      var participantsToKeep = new Set(); // eslint-disable-next-line no-warning-comments\n      // TODO(mroberts): Remove me once the Server is fixed.\n\n      (roomState.participants || []).forEach(function (participantState) {\n        if (participantState.sid === _this3.localParticipant.sid || _this3._disconnectedParticipantSids.has(participantState.sid)) {\n          return;\n        }\n\n        var participant = _this3._getOrCreateRemoteParticipant(participantState);\n\n        participant.update(participantState);\n        participantsToKeep.add(participant);\n      });\n\n      if (roomState.type === 'synced') {\n        this.participants.forEach(function (participant) {\n          if (!participantsToKeep.has(participant)) {\n            participant.disconnect();\n          }\n        });\n      }\n\n      handleSubscriptions(this); // eslint-disable-next-line no-warning-comments\n      // TODO(mroberts): Remove me once the Server is fixed.\n\n      /* eslint camelcase:0 */\n\n      if (roomState.peer_connections) {\n        this._peerConnectionManager.update(roomState.peer_connections, roomState.type === 'synced');\n      }\n\n      if (roomState.recording) {\n        this.recording.update(roomState.recording);\n      }\n\n      if (roomState.published && roomState.published.revision > this._publishedRevision) {\n        this._publishedRevision = roomState.published.revision;\n        roomState.published.tracks.forEach(function (track) {\n          if (track.sid) {\n            _this3._published.set(track.id, track.sid);\n          }\n        });\n        this.localParticipant.update(roomState.published);\n      }\n\n      if (roomState.participant) {\n        this.localParticipant.connect(roomState.participant.sid, roomState.participant.identity);\n      }\n\n      if (!this._dominantSpeakerSignalingPromise && roomState.media_signaling && roomState.media_signaling.active_speaker && roomState.media_signaling.active_speaker.transport && roomState.media_signaling.active_speaker.transport.type === 'data-channel') {\n        this._setupDataTransportBackedDominantSpeakerSignaling(roomState.media_signaling.active_speaker.transport.label);\n      }\n\n      if (!this._networkQualityMonitorPromise && roomState.media_signaling && roomState.media_signaling.network_quality && roomState.media_signaling.network_quality.transport && roomState.media_signaling.network_quality.transport.type === 'data-channel') {\n        this._setupDataTransportBackedNetworkQualityMonitor(roomState.media_signaling.network_quality.transport.label);\n      }\n\n      if (!this._trackPriorityPromise && roomState.media_signaling && roomState.media_signaling.track_priority && roomState.media_signaling.track_priority.transport && roomState.media_signaling.track_priority.transport.type === 'data-channel') {\n        this._setupTrackPrioritySignaling(roomState.media_signaling.track_priority.transport.label);\n      }\n\n      if (!this._trackSwitchOffPromise && roomState.media_signaling && roomState.media_signaling.track_switch_off && roomState.media_signaling.track_switch_off.transport && roomState.media_signaling.track_switch_off.transport.type === 'data-channel') {\n        this._setupTrackSwitchOffMonitor(roomState.media_signaling.track_switch_off.transport.label);\n      }\n\n      return this;\n    } // track priority signaling MSP is now used only for subscribe side priority changes.\n    // publisher side priority changes and notifications are handled by RSP.\n\n  }, {\n    key: '_setupTrackPrioritySignaling',\n    value: function _setupTrackPrioritySignaling(id) {\n      var _this4 = this;\n\n      this._teardownTrackPrioritySignaling();\n\n      var trackPriorityPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }\n\n        if (_this4._trackPriorityPromise !== trackPriorityPromise) {\n          return;\n        } // NOTE(mmalavalli): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and a new RTCDataChannel is created in order\n        // to resume sending Track Priority updates.\n\n\n        receiver.once('close', function () {\n          return _this4._teardownTrackPrioritySignaling();\n        });\n        var trackPrioritySignaling = new _this4._TrackPrioritySignaling(receiver.toDataTransport());\n        [].concat(_toConsumableArray(_this4.participants.values())).forEach(function (participant) {\n          participant.setTrackPrioritySignaling(trackPrioritySignaling);\n        });\n      });\n\n      this._trackPriorityPromise = trackPriorityPromise;\n    }\n  }, {\n    key: '_setupTrackSwitchOff',\n    value: function _setupTrackSwitchOff(trackSwitchOffSignaling) {\n      var _this5 = this;\n\n      this._trackSwitchOffSignaling = trackSwitchOffSignaling;\n      trackSwitchOffSignaling.on('updated', function (tracksOff, tracksOn) {\n        _this5.participants.forEach(function (participant) {\n          participant.tracks.forEach(function (track) {\n            if (tracksOff.includes(track.sid)) {\n              track.setSwitchedOff(true);\n            }\n\n            if (tracksOn.includes(track.sid)) {\n              track.setSwitchedOff(false);\n            }\n          });\n        });\n      });\n    }\n  }, {\n    key: '_setupTrackSwitchOffMonitor',\n    value: function _setupTrackSwitchOffMonitor(id) {\n      var _this6 = this;\n\n      this._teardownTrackSwitchOff();\n\n      var trackSwitchOffPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }\n\n        if (_this6._trackSwitchOffPromise !== trackSwitchOffPromise) {\n          return;\n        } // NOTE(mpatwardhan): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and a new RTCDataChannel is created in order\n        // to resume sending Dominant Speaker updates.\n\n\n        receiver.once('close', function () {\n          return _this6._teardownTrackSwitchOff();\n        });\n        var trackSwitchOffSignaling = new _this6._TrackSwitchOffSignaling(receiver.toDataTransport());\n\n        _this6._setupTrackSwitchOff(trackSwitchOffSignaling);\n      });\n\n      this._trackSwitchOffPromise = trackSwitchOffPromise;\n    }\n    /**\n     * Create a {@link DataTransport}-backed {@link DominantSpeakerSignaling}.\n     * @private\n     * @param {ID} id - ID of the {@link DataTrackReceiver} that will ultimately\n     *   be converted into a {@link DataTrackTransport} for use with\n     *   {@link DominantSpeakerSignaling}\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setupDataTransportBackedDominantSpeakerSignaling',\n    value: function _setupDataTransportBackedDominantSpeakerSignaling(id) {\n      var _this7 = this;\n\n      this._teardownDominantSpeakerSignaling();\n\n      var dominantSpeakerSignalingPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }\n\n        if (_this7._dominantSpeakerSignalingPromise !== dominantSpeakerSignalingPromise) {\n          // NOTE(mroberts): _teardownDominantSpeakerSignaling was called.\n          return;\n        } // NOTE(mpatwardhan): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and a new RTCDataChannel is created in order\n        // to resume sending Dominant Speaker updates.\n\n\n        receiver.once('close', function () {\n          return _this7._teardownDominantSpeakerSignaling();\n        });\n        var dominantSpeakerSignaling = new _this7._DominantSpeakerSignaling(receiver.toDataTransport());\n\n        _this7._setDominantSpeakerSignaling(dominantSpeakerSignaling);\n      });\n\n      this._dominantSpeakerSignalingPromise = dominantSpeakerSignalingPromise;\n    }\n    /**\n     * Create a {@link DataTransport}-backed {@link NetworkQualityMonitor}.\n     * @private\n     * @param {ID} id - ID of the {@link DataTrackReceiver} that will ultimately\n     *   be converted into a {@link DataTrackTransport} for use with\n     *   {@link NetworkQualitySignaling}\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setupDataTransportBackedNetworkQualityMonitor',\n    value: function _setupDataTransportBackedNetworkQualityMonitor(id) {\n      var _this8 = this;\n\n      var self = this;\n\n      this._teardownNetworkQualityMonitor();\n\n      var networkQualityMonitorPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }\n\n        if (_this8._networkQualityMonitorPromise !== networkQualityMonitorPromise) {\n          // NOTE(mroberts): _teardownNetworkQualityMonitor was called.\n          return;\n        } // NOTE(mpatwardhan): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and new a RTCDataChannel is created in order\n        // to resume exchanging Network Quality messages.\n\n\n        receiver.once('close', function () {\n          return _this8._teardownNetworkQualityMonitor();\n        });\n        var networkQualitySignaling = new _this8._NetworkQualitySignaling(receiver.toDataTransport(), self._networkQualityConfiguration);\n        var networkQualityMonitor = new _this8._NetworkQualityMonitor(_this8._peerConnectionManager, networkQualitySignaling);\n\n        _this8._setNetworkQualityMonitor(networkQualityMonitor);\n      });\n\n      this._networkQualityMonitorPromise = networkQualityMonitorPromise;\n    }\n  }, {\n    key: '_setDominantSpeakerSignaling',\n    value: function _setDominantSpeakerSignaling(dominantSpeakerSignaling) {\n      var _this9 = this;\n\n      this._dominantSpeakerSignaling = dominantSpeakerSignaling;\n      dominantSpeakerSignaling.on('updated', function () {\n        return _this9.setDominantSpeaker(dominantSpeakerSignaling.loudestParticipantSid);\n      });\n    }\n  }, {\n    key: '_setNetworkQualityMonitor',\n    value: function _setNetworkQualityMonitor(networkQualityMonitor) {\n      var _this10 = this;\n\n      this._networkQualityMonitor = networkQualityMonitor;\n      networkQualityMonitor.on('updated', function () {\n        if (_this10.mediaConnectionState === 'failed') {\n          return;\n        }\n\n        _this10.localParticipant.setNetworkQualityLevel(networkQualityMonitor.level, networkQualityMonitor.levels);\n\n        _this10.participants.forEach(function (participant) {\n          var levels = networkQualityMonitor.remoteLevels.get(participant.sid);\n\n          if (levels) {\n            participant.setNetworkQualityLevel(levels.level, levels);\n          }\n        });\n      });\n      networkQualityMonitor.start();\n    }\n  }, {\n    key: '_teardownDominantSpeakerSignaling',\n    value: function _teardownDominantSpeakerSignaling() {\n      this._dominantSpeakerSignalingPromise = null;\n      this._dominantSpeakerSignaling = null;\n    }\n  }, {\n    key: '_teardownNetworkQualityMonitor',\n    value: function _teardownNetworkQualityMonitor() {\n      this._networkQualityMonitorPromise = null;\n\n      if (this._networkQualityMonitor) {\n        this._networkQualityMonitor.stop();\n\n        this._networkQualityMonitor = null;\n      }\n    }\n  }, {\n    key: '_teardownTrackPrioritySignaling',\n    value: function _teardownTrackPrioritySignaling() {\n      this._trackPrioritySignaling = null;\n      this._trackPriorityPromise = null;\n      this.localParticipant.setTrackPrioritySignaling(null);\n      this.participants.forEach(function (participant) {\n        participant.setTrackPrioritySignaling(null);\n      });\n    }\n  }, {\n    key: '_teardownTrackSwitchOff',\n    value: function _teardownTrackSwitchOff() {\n      this._trackSwitchOffSignaling = null;\n      this._trackSwitchOffPromise = null;\n    }\n    /**\n     * Get the {@link RoomV2}'s media statistics.\n     * @returns {Promise.<Map<PeerConnectionV2#id, StandardizedStatsResponse>>}\n     */\n\n  }, {\n    key: 'getStats',\n    value: function getStats() {\n      var _this11 = this;\n\n      return this._peerConnectionManager.getStats().then(function (responses) {\n        return new Map(Array.from(responses).map(function (_ref) {\n          var _ref2 = _slicedToArray(_ref, 2),\n              id = _ref2[0],\n              response = _ref2[1];\n\n          return [id, Object.assign({}, response, {\n            localAudioTrackStats: filterAndAddLocalTrackSids(_this11, response.localAudioTrackStats),\n            localVideoTrackStats: filterAndAddLocalTrackSids(_this11, response.localVideoTrackStats),\n            remoteAudioTrackStats: filterAndAddRemoteTrackSids(_this11, response.remoteAudioTrackStats),\n            remoteVideoTrackStats: filterAndAddRemoteTrackSids(_this11, response.remoteVideoTrackStats)\n          })];\n        }));\n      });\n    }\n  }, {\n    key: 'signalingConnectionState',\n    get: function get() {\n      return this._transport.state === 'syncing' ? 'reconnecting' : this._transport.state;\n    }\n    /**\n     * The Media Connection State\n     * @property {RTCIceConnectionState}\n     */\n\n  }, {\n    key: 'mediaConnectionState',\n    get: function get() {\n      return this._peerConnectionManager.iceConnectionState;\n    }\n  }]);\n\n  return RoomV2;\n}(RoomSignaling);\n/**\n * Filter out {@link TrackStats} that aren't in the collection while also\n * stamping their Track SIDs.\n * @param {Map<ID, SID>} idToSid\n * @param {Array<TrackStats>} trackStats\n * @returns {Array<TrackStats>}\n */\n\n\nfunction filterAndAddTrackSids(idToSid, trackStats) {\n  return trackStats.reduce(function (trackStats, trackStat) {\n    var trackSid = idToSid.get(trackStat.trackId);\n    return trackSid ? [Object.assign({}, trackStat, {\n      trackSid: trackSid\n    })].concat(trackStats) : trackStats;\n  }, []);\n}\n/**\n * Filter out {@link LocalTrackStats} that aren't currently published while also\n * stamping their Track SIDs.\n * @param {RoomV2} roomV2\n * @param {Array<LocalTrackStats>} localTrackStats\n * @returns {Array<LocalTrackStats>}\n */\n\n\nfunction filterAndAddLocalTrackSids(roomV2, localTrackStats) {\n  return filterAndAddTrackSids(roomV2._published, localTrackStats);\n}\n/**\n * Filter out {@link RemoteTrackStats} that aren't currently subscribed while\n * also stamping their Track SIDs.\n * @param {RoomV2} roomV2\n * @param {Array<RemoteTrackStats>} remoteTrackStats\n * @returns {Array<RemoteTrackStats>}\n */\n\n\nfunction filterAndAddRemoteTrackSids(roomV2, remoteTrackStats) {\n  var idToSid = new Map(Array.from(roomV2._subscribed.entries()).map(function (_ref3) {\n    var _ref4 = _slicedToArray(_ref3, 2),\n        sid = _ref4[0],\n        id = _ref4[1];\n\n    return [id, sid];\n  }));\n  return filterAndAddTrackSids(idToSid, remoteTrackStats);\n}\n/**\n * @typedef {object} RoomV2#Representation\n * @property {string} name\n * @property {LocalParticipantV2#Representation} participant\n * @property {?Array<RemoteParticipantV2#Representation>} participants\n * @property {?Array<PeerConnectionV2#Representation>} peer_connections\n * @property {?RecordingV2#Representation} recording\n * @property {string} sid\n */\n\n\nfunction handleLocalParticipantEvents(roomV2, localParticipant) {\n  var localParticipantUpdated = oncePerTick(function () {\n    roomV2._publishNewLocalParticipantState();\n  });\n  var renegotiate = oncePerTick(function () {\n    var trackSenders = flatMap(localParticipant.tracks, function (trackV2) {\n      return trackV2.trackTransceiver;\n    });\n\n    roomV2._peerConnectionManager.setTrackSenders(trackSenders);\n  });\n  localParticipant.on('trackAdded', renegotiate);\n  localParticipant.on('trackRemoved', renegotiate);\n  localParticipant.on('updated', localParticipantUpdated);\n  roomV2.on('stateChanged', function stateChanged(state) {\n    if (state === 'disconnected') {\n      localParticipant.removeListener('trackAdded', renegotiate);\n      localParticipant.removeListener('trackRemoved', renegotiate);\n      localParticipant.removeListener('updated', localParticipantUpdated);\n      roomV2.removeListener('stateChanged', stateChanged);\n      localParticipant.disconnect();\n    }\n  });\n}\n\nfunction handlePeerConnectionEvents(roomV2, peerConnectionManager) {\n  peerConnectionManager.on('description', function onDescription(description) {\n    roomV2._publishPeerConnectionState(description);\n  });\n  peerConnectionManager.dequeue('description');\n  peerConnectionManager.on('candidates', function onCandidates(candidates) {\n    roomV2._publishPeerConnectionState(candidates);\n  });\n  peerConnectionManager.dequeue('candidates');\n  peerConnectionManager.on('trackAdded', roomV2._addTrackReceiver.bind(roomV2));\n  peerConnectionManager.dequeue('trackAdded');\n  peerConnectionManager.getTrackReceivers().forEach(roomV2._addTrackReceiver, roomV2);\n  peerConnectionManager.on('iceConnectionStateChanged', function () {\n    roomV2.emit('mediaConnectionStateChanged');\n\n    if (roomV2.mediaConnectionState === 'failed') {\n      if (roomV2.localParticipant.networkQualityLevel !== null) {\n        roomV2.localParticipant.setNetworkQualityLevel(0);\n      }\n\n      roomV2.participants.forEach(function (participant) {\n        if (participant.networkQualityLevel !== null) {\n          participant.setNetworkQualityLevel(0);\n        }\n      });\n    }\n  });\n}\n\nfunction handleTransportEvents(roomV2, transport) {\n  transport.on('message', roomV2._update.bind(roomV2));\n  transport.on('stateChanged', function stateChanged(state, error) {\n    if (state === 'disconnected') {\n      if (roomV2.state !== 'disconnected') {\n        roomV2._disconnect(error);\n      }\n\n      transport.removeListener('stateChanged', stateChanged);\n    }\n\n    roomV2.emit('signalingConnectionStateChanged');\n  });\n}\n/**\n * Periodically publish {@link StatsReport}s.\n * @private\n * @param {RoomV2} roomV2\n * @param {Transport} transport\n * @param {Number} intervalMs\n */\n\n\nfunction periodicallyPublishStats(roomV2, transport, intervalMs) {\n  var interval = setInterval(function () {\n    roomV2.getStats().then(function (stats) {\n      stats.forEach(function (response, id) {\n        // NOTE(mmalavalli): A StatsReport is used to publish a \"stats-report\"\n        // event instead of using StandardizedStatsResponse directly because\n        // StatsReport will add nulls to properties that do not exist.\n        var report = new StatsReport(id, response);\n        transport.publishEvent('quality', 'stats-report', {\n          audioTrackStats: report.remoteAudioTrackStats,\n          localAudioTrackStats: report.localAudioTrackStats,\n          localVideoTrackStats: report.localVideoTrackStats,\n          peerConnectionId: report.peerConnectionId,\n          videoTrackStats: report.remoteVideoTrackStats\n        }); // NOTE(mmalavalli): null properties of the \"active-ice-candidate-pair\"\n        // payload are assigned default values until the Insights gateway\n        // accepts null values.\n\n        var activeIceCandidatePair = replaceNullsWithDefaults(response.activeIceCandidatePair, report.peerConnectionId);\n        transport.publishEvent('quality', 'active-ice-candidate-pair', activeIceCandidatePair);\n      });\n    }, function () {// Do nothing.\n    });\n  }, intervalMs);\n  roomV2.on('stateChanged', function onStateChanged(state) {\n    if (state === 'disconnected') {\n      clearInterval(interval);\n      roomV2.removeListener('stateChanged', onStateChanged);\n    }\n  });\n}\n\nfunction handleSubscriptions(room) {\n  var trackSidsToTrackSignalings = room._getTrackSidsToTrackSignalings();\n\n  room._subscriptionFailures.forEach(function (error, trackSid) {\n    var trackSignaling = trackSidsToTrackSignalings.get(trackSid);\n\n    if (trackSignaling) {\n      room._subscriptionFailures.delete(trackSid);\n\n      trackSignaling.subscribeFailed(createTwilioError(error.code, error.message));\n    }\n  });\n\n  trackSidsToTrackSignalings.forEach(function (trackSignaling) {\n    var trackId = room._subscribed.get(trackSignaling.sid);\n\n    if (!trackId || trackSignaling.isSubscribed && trackSignaling.trackTransceiver.id !== trackId) {\n      trackSignaling.setTrackTransceiver(null);\n    }\n\n    if (trackId) {\n      room._getTrackReceiver(trackId).then(function (trackReceiver) {\n        return trackSignaling.setTrackTransceiver(trackReceiver);\n      });\n    }\n  });\n}\n\nfunction replaceNullsWithDefaults(activeIceCandidatePair, peerConnectionId) {\n  activeIceCandidatePair = Object.assign({\n    availableIncomingBitrate: 0,\n    availableOutgoingBitrate: 0,\n    bytesReceived: 0,\n    bytesSent: 0,\n    consentRequestsSent: 0,\n    currentRoundTripTime: 0,\n    lastPacketReceivedTimestamp: 0,\n    lastPacketSentTimestamp: 0,\n    nominated: false,\n    peerConnectionId: peerConnectionId,\n    priority: 0,\n    readable: false,\n    requestsReceived: 0,\n    requestsSent: 0,\n    responsesReceived: 0,\n    responsesSent: 0,\n    retransmissionsReceived: 0,\n    retransmissionsSent: 0,\n    state: 'failed',\n    totalRoundTripTime: 0,\n    transportId: '',\n    writable: false\n  }, filterObject(activeIceCandidatePair || {}, null));\n  activeIceCandidatePair.localCandidate = Object.assign({\n    candidateType: 'host',\n    deleted: false,\n    ip: '',\n    port: 0,\n    priority: 0,\n    protocol: 'udp',\n    relayProtocol: 'udp',\n    url: ''\n  }, filterObject(activeIceCandidatePair.localCandidate || {}, null));\n  activeIceCandidatePair.remoteCandidate = Object.assign({\n    candidateType: 'host',\n    ip: '',\n    port: 0,\n    priority: 0,\n    protocol: 'udp',\n    url: ''\n  }, filterObject(activeIceCandidatePair.remoteCandidate || {}, null));\n  return activeIceCandidatePair;\n}\n\nmodule.exports = RoomV2;","map":{"version":3,"sources":["/Users/chris/Desktop/call-me/client/node_modules/twilio-video/es5/signaling/v2/room.js"],"names":["_slicedToArray","sliceIterator","arr","i","_arr","_n","_d","_e","undefined","_i","Symbol","iterator","_s","next","done","push","value","length","err","Array","isArray","Object","TypeError","_createClass","defineProperties","target","props","descriptor","enumerable","configurable","writable","defineProperty","key","Constructor","protoProps","staticProps","prototype","_get","get","object","property","receiver","Function","desc","getOwnPropertyDescriptor","parent","getPrototypeOf","getter","call","_toConsumableArray","arr2","from","_classCallCheck","instance","_possibleConstructorReturn","self","ReferenceError","_inherits","subClass","superClass","create","constructor","setPrototypeOf","__proto__","DominantSpeakerSignaling","require","NetworkQualityMonitor","NetworkQualitySignaling","RecordingV2","RoomSignaling","RemoteParticipantV2","StatsReport","TrackPrioritySignaling","TrackSwitchOffSignaling","_require","createBandwidthProfilePayload","defer","filterObject","flatMap","oncePerTick","_require2","createTwilioError","STATS_PUBLISH_INTERVAL_MS","RoomV2","_RoomSignaling","localParticipant","initialState","transport","peerConnectionManager","options","assign","RecordingSignaling","bandwidthProfile","statsPublishIntervalMs","setBandwidthProfile","_this","sid","name","_dominantSpeakerSignaling","_DominantSpeakerSignaling","_dominantSpeakerSignalingPromise","_disconnectedParticipantSids","Set","_NetworkQualityMonitor","_NetworkQualitySignaling","_lastBandwidthProfileRevision","bandwidthProfileRevision","_networkQualityMonitor","_networkQualityMonitorPromise","_networkQualityConfiguration","networkQualityConfiguration","_peerConnectionManager","_published","Map","_publishedRevision","_RemoteParticipantV2","_subscribed","_subscribedRevision","_subscriptionFailures","_trackPriorityPromise","_trackPrioritySignaling","_trackSwitchOffPromise","_trackSwitchOffSignaling","_TrackPrioritySignaling","_TrackSwitchOffSignaling","_transport","_trackReceiverDeferreds","handleLocalParticipantEvents","handlePeerConnectionEvents","handleTransportEvents","periodicallyPublishStats","_update","_deleteTrackReceiverDeferred","id","delete","_getOrCreateTrackReceiverDeferred","deferred","trackReceivers","getTrackReceivers","trackReceiver","find","readyState","resolve","set","_addTrackReceiver","_disconnect","error","didDisconnect","_teardownDominantSpeakerSignaling","_teardownNetworkQualityMonitor","disconnect","close","tracks","forEach","track","publishFailed","Error","_getTrackReceiver","_this2","promise","then","_getTrackSidsToTrackSignalings","trackSidsToTrackSignalings","participants","participant","_getOrCreateRemoteParticipant","participantState","bind","on","stateChanged","state","removeListener","add","connectParticipant","setTrackPrioritySignaling","_getState","getState","_maybeAddBandwidthProfile","update","_localParticipant","bandwidth_profile","_publishNewLocalParticipantState","publish","_publishPeerConnectionState","peerConnectionState","peer_connections","roomState","_this3","subscribed","revision","trackState","has","subscribedTrackSids","filter","map","trackId","trackSid","participantsToKeep","type","handleSubscriptions","recording","published","connect","identity","media_signaling","active_speaker","_setupDataTransportBackedDominantSpeakerSignaling","label","network_quality","_setupDataTransportBackedNetworkQualityMonitor","track_priority","_setupTrackPrioritySignaling","track_switch_off","_setupTrackSwitchOffMonitor","_this4","_teardownTrackPrioritySignaling","trackPriorityPromise","kind","once","trackPrioritySignaling","toDataTransport","concat","values","_setupTrackSwitchOff","trackSwitchOffSignaling","_this5","tracksOff","tracksOn","includes","setSwitchedOff","_this6","_teardownTrackSwitchOff","trackSwitchOffPromise","_this7","dominantSpeakerSignalingPromise","dominantSpeakerSignaling","_setDominantSpeakerSignaling","_this8","networkQualityMonitorPromise","networkQualitySignaling","networkQualityMonitor","_setNetworkQualityMonitor","_this9","setDominantSpeaker","loudestParticipantSid","_this10","mediaConnectionState","setNetworkQualityLevel","level","levels","remoteLevels","start","stop","getStats","_this11","responses","_ref","_ref2","response","localAudioTrackStats","filterAndAddLocalTrackSids","localVideoTrackStats","remoteAudioTrackStats","filterAndAddRemoteTrackSids","remoteVideoTrackStats","iceConnectionState","filterAndAddTrackSids","idToSid","trackStats","reduce","trackStat","roomV2","localTrackStats","remoteTrackStats","entries","_ref3","_ref4","localParticipantUpdated","renegotiate","trackSenders","trackV2","trackTransceiver","setTrackSenders","onDescription","description","dequeue","onCandidates","candidates","emit","networkQualityLevel","intervalMs","interval","setInterval","stats","report","publishEvent","audioTrackStats","peerConnectionId","videoTrackStats","activeIceCandidatePair","replaceNullsWithDefaults","onStateChanged","clearInterval","room","trackSignaling","subscribeFailed","code","message","isSubscribed","setTrackTransceiver","availableIncomingBitrate","availableOutgoingBitrate","bytesReceived","bytesSent","consentRequestsSent","currentRoundTripTime","lastPacketReceivedTimestamp","lastPacketSentTimestamp","nominated","priority","readable","requestsReceived","requestsSent","responsesReceived","responsesSent","retransmissionsReceived","retransmissionsSent","totalRoundTripTime","transportId","localCandidate","candidateType","deleted","ip","port","protocol","relayProtocol","url","remoteCandidate","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"]) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); } }; }();\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nvar _get = function get(object, property, receiver) { if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return get(parent, property, receiver); } } else if (\"value\" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } };\n\nfunction _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\nvar DominantSpeakerSignaling = require('./dominantspeakersignaling');\nvar NetworkQualityMonitor = require('./networkqualitymonitor');\nvar NetworkQualitySignaling = require('./networkqualitysignaling');\nvar RecordingV2 = require('./recording');\nvar RoomSignaling = require('../room');\nvar RemoteParticipantV2 = require('./remoteparticipant');\nvar StatsReport = require('../../stats/statsreport');\nvar TrackPrioritySignaling = require('./trackprioritysignaling');\nvar TrackSwitchOffSignaling = require('./trackswitchoffsignaling');\n\nvar _require = require('../../util'),\n    createBandwidthProfilePayload = _require.createBandwidthProfilePayload,\n    defer = _require.defer,\n    filterObject = _require.filterObject,\n    flatMap = _require.flatMap,\n    oncePerTick = _require.oncePerTick;\n\nvar _require2 = require('../../util/twilio-video-errors'),\n    createTwilioError = _require2.createTwilioError;\n\nvar STATS_PUBLISH_INTERVAL_MS = 1000;\n\n/**\n * @extends RoomSignaling\n */\n\nvar RoomV2 = function (_RoomSignaling) {\n  _inherits(RoomV2, _RoomSignaling);\n\n  function RoomV2(localParticipant, initialState, transport, peerConnectionManager, options) {\n    _classCallCheck(this, RoomV2);\n\n    options = Object.assign({\n      DominantSpeakerSignaling: DominantSpeakerSignaling,\n      NetworkQualityMonitor: NetworkQualityMonitor,\n      NetworkQualitySignaling: NetworkQualitySignaling,\n      RecordingSignaling: RecordingV2,\n      RemoteParticipantV2: RemoteParticipantV2,\n      TrackPrioritySignaling: TrackPrioritySignaling,\n      TrackSwitchOffSignaling: TrackSwitchOffSignaling,\n      bandwidthProfile: null,\n      statsPublishIntervalMs: STATS_PUBLISH_INTERVAL_MS\n    }, options);\n    localParticipant.setBandwidthProfile(options.bandwidthProfile);\n\n    var _this = _possibleConstructorReturn(this, (RoomV2.__proto__ || Object.getPrototypeOf(RoomV2)).call(this, localParticipant, initialState.sid, initialState.name, options));\n\n    Object.defineProperties(_this, {\n      _dominantSpeakerSignaling: {\n        value: null,\n        writable: true\n      },\n      _DominantSpeakerSignaling: {\n        value: options.DominantSpeakerSignaling\n      },\n      _dominantSpeakerSignalingPromise: {\n        value: null,\n        writable: true\n      },\n      _disconnectedParticipantSids: {\n        value: new Set()\n      },\n      _NetworkQualityMonitor: {\n        value: options.NetworkQualityMonitor\n      },\n      _NetworkQualitySignaling: {\n        value: options.NetworkQualitySignaling\n      },\n      _lastBandwidthProfileRevision: {\n        value: localParticipant.bandwidthProfileRevision,\n        writable: true\n      },\n      _networkQualityMonitor: {\n        value: null,\n        writable: true\n      },\n      _networkQualityMonitorPromise: {\n        value: null,\n        writable: true\n      },\n      _networkQualityConfiguration: {\n        value: localParticipant.networkQualityConfiguration\n      },\n      _peerConnectionManager: {\n        value: peerConnectionManager\n      },\n      _published: {\n        value: new Map()\n      },\n      _publishedRevision: {\n        value: 0,\n        writable: true\n      },\n      _RemoteParticipantV2: {\n        value: options.RemoteParticipantV2\n      },\n      _subscribed: {\n        value: new Map()\n      },\n      _subscribedRevision: {\n        value: 0,\n        writable: true\n      },\n      _subscriptionFailures: {\n        value: new Map()\n      },\n      _trackPriorityPromise: {\n        value: null,\n        writable: true\n      },\n      _trackPrioritySignaling: {\n        value: null,\n        writable: true\n      },\n      _trackSwitchOffPromise: {\n        value: null,\n        writable: true\n      },\n      _trackSwitchOffSignaling: {\n        value: null,\n        writable: true\n      },\n      _TrackPrioritySignaling: {\n        value: options.TrackPrioritySignaling\n      },\n      _TrackSwitchOffSignaling: {\n        value: options.TrackSwitchOffSignaling\n      },\n      _transport: {\n        value: transport\n      },\n      _trackReceiverDeferreds: {\n        value: new Map()\n      }\n    });\n\n    handleLocalParticipantEvents(_this, localParticipant);\n    handlePeerConnectionEvents(_this, peerConnectionManager);\n    handleTransportEvents(_this, transport);\n    periodicallyPublishStats(_this, transport, options.statsPublishIntervalMs);\n\n    _this._update(initialState);\n    return _this;\n  }\n\n  /**\n   * The Signaling Connection State\n   * @property {string} - \"connected\", \"reconnecting\", \"disconnected\"\n   */\n\n\n  _createClass(RoomV2, [{\n    key: '_deleteTrackReceiverDeferred',\n\n\n    /**\n     * @private\n     */\n    value: function _deleteTrackReceiverDeferred(id) {\n      return this._trackReceiverDeferreds.delete(id);\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getOrCreateTrackReceiverDeferred',\n    value: function _getOrCreateTrackReceiverDeferred(id) {\n      var deferred = this._trackReceiverDeferreds.get(id) || defer();\n      var trackReceivers = this._peerConnectionManager.getTrackReceivers();\n\n      // NOTE(mmalavalli): In Firefox, there can be instances where a MediaStreamTrack\n      // for the given Track ID already exists, for example, when a Track is removed\n      // and added back. If that is the case, then we should resolve 'deferred'.\n      var trackReceiver = trackReceivers.find(function (trackReceiver) {\n        return trackReceiver.id === id && trackReceiver.readyState !== 'ended';\n      });\n\n      if (trackReceiver) {\n        deferred.resolve(trackReceiver);\n      } else {\n        // NOTE(mmalavalli): Only add the 'deferred' to the map if it's not\n        // resolved. This will prevent old copies of the MediaStreamTrack from\n        // being used when the remote peer removes and re-adds a MediaStreamTrack.\n        this._trackReceiverDeferreds.set(id, deferred);\n      }\n\n      return deferred;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_addTrackReceiver',\n    value: function _addTrackReceiver(trackReceiver) {\n      var deferred = this._getOrCreateTrackReceiverDeferred(trackReceiver.id);\n      deferred.resolve(trackReceiver);\n      return this;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_disconnect',\n    value: function _disconnect(error) {\n      var didDisconnect = _get(RoomV2.prototype.__proto__ || Object.getPrototypeOf(RoomV2.prototype), '_disconnect', this).call(this, error);\n      if (didDisconnect) {\n        this._teardownDominantSpeakerSignaling();\n        this._teardownNetworkQualityMonitor();\n        this._transport.disconnect();\n        this._peerConnectionManager.close();\n      }\n\n      this.localParticipant.tracks.forEach(function (track) {\n        track.publishFailed(error || new Error('LocalParticipant disconnected'));\n      });\n\n      return didDisconnect;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getTrackReceiver',\n    value: function _getTrackReceiver(id) {\n      var _this2 = this;\n\n      return this._getOrCreateTrackReceiverDeferred(id).promise.then(function (trackReceiver) {\n        _this2._deleteTrackReceiverDeferred(id);\n        return trackReceiver;\n      });\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getTrackSidsToTrackSignalings',\n    value: function _getTrackSidsToTrackSignalings() {\n      var trackSidsToTrackSignalings = flatMap(this.participants, function (participant) {\n        return Array.from(participant.tracks);\n      });\n      return new Map(trackSidsToTrackSignalings);\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getOrCreateRemoteParticipant',\n    value: function _getOrCreateRemoteParticipant(participantState) {\n      var RemoteParticipantV2 = this._RemoteParticipantV2;\n      var participant = this.participants.get(participantState.sid);\n      var self = this;\n      if (!participant) {\n        participant = new RemoteParticipantV2(participantState, this._getTrackReceiver.bind(this));\n        participant.on('stateChanged', function stateChanged(state) {\n          if (state === 'disconnected') {\n            participant.removeListener('stateChanged', stateChanged);\n            self.participants.delete(participant.sid);\n            self._disconnectedParticipantSids.add(participant.sid);\n          }\n        });\n        this.connectParticipant(participant);\n        participant.setTrackPrioritySignaling(this._trackPrioritySignaling);\n      }\n      return participant;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getState',\n    value: function _getState() {\n      return {\n        participant: this.localParticipant.getState()\n      };\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_maybeAddBandwidthProfile',\n    value: function _maybeAddBandwidthProfile(update) {\n      var _localParticipant = this.localParticipant,\n          bandwidthProfile = _localParticipant.bandwidthProfile,\n          bandwidthProfileRevision = _localParticipant.bandwidthProfileRevision;\n\n      if (bandwidthProfile && this._lastBandwidthProfileRevision < bandwidthProfileRevision) {\n        this._lastBandwidthProfileRevision = bandwidthProfileRevision;\n        return Object.assign({\n          bandwidth_profile: createBandwidthProfilePayload(bandwidthProfile)\n        }, update);\n      }\n      return update;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_publishNewLocalParticipantState',\n    value: function _publishNewLocalParticipantState() {\n      this._transport.publish(this._maybeAddBandwidthProfile(this._getState()));\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_publishPeerConnectionState',\n    value: function _publishPeerConnectionState(peerConnectionState) {\n      /* eslint camelcase:0 */\n      this._transport.publish(Object.assign({\n        peer_connections: [peerConnectionState]\n      }, this._getState()));\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_update',\n    value: function _update(roomState) {\n      var _this3 = this;\n\n      if (roomState.subscribed && roomState.subscribed.revision > this._subscribedRevision) {\n        this._subscribedRevision = roomState.subscribed.revision;\n        roomState.subscribed.tracks.forEach(function (trackState) {\n          if (trackState.id) {\n            _this3._subscriptionFailures.delete(trackState.sid);\n            _this3._subscribed.set(trackState.sid, trackState.id);\n          } else if (trackState.error && !_this3._subscriptionFailures.has(trackState.sid)) {\n            _this3._subscriptionFailures.set(trackState.sid, trackState.error);\n          }\n        });\n\n        var subscribedTrackSids = new Set(roomState.subscribed.tracks.filter(function (trackState) {\n          return !!trackState.id;\n        }).map(function (trackState) {\n          return trackState.sid;\n        }));\n\n        this._subscribed.forEach(function (trackId, trackSid) {\n          if (!subscribedTrackSids.has(trackSid)) {\n            _this3._subscribed.delete(trackSid);\n          }\n        });\n      }\n\n      var participantsToKeep = new Set();\n\n      // eslint-disable-next-line no-warning-comments\n      // TODO(mroberts): Remove me once the Server is fixed.\n      (roomState.participants || []).forEach(function (participantState) {\n        if (participantState.sid === _this3.localParticipant.sid || _this3._disconnectedParticipantSids.has(participantState.sid)) {\n          return;\n        }\n        var participant = _this3._getOrCreateRemoteParticipant(participantState);\n        participant.update(participantState);\n        participantsToKeep.add(participant);\n      });\n\n      if (roomState.type === 'synced') {\n        this.participants.forEach(function (participant) {\n          if (!participantsToKeep.has(participant)) {\n            participant.disconnect();\n          }\n        });\n      }\n\n      handleSubscriptions(this);\n\n      // eslint-disable-next-line no-warning-comments\n      // TODO(mroberts): Remove me once the Server is fixed.\n      /* eslint camelcase:0 */\n      if (roomState.peer_connections) {\n        this._peerConnectionManager.update(roomState.peer_connections, roomState.type === 'synced');\n      }\n\n      if (roomState.recording) {\n        this.recording.update(roomState.recording);\n      }\n\n      if (roomState.published && roomState.published.revision > this._publishedRevision) {\n        this._publishedRevision = roomState.published.revision;\n        roomState.published.tracks.forEach(function (track) {\n          if (track.sid) {\n            _this3._published.set(track.id, track.sid);\n          }\n        });\n        this.localParticipant.update(roomState.published);\n      }\n\n      if (roomState.participant) {\n        this.localParticipant.connect(roomState.participant.sid, roomState.participant.identity);\n      }\n\n      if (!this._dominantSpeakerSignalingPromise && roomState.media_signaling && roomState.media_signaling.active_speaker && roomState.media_signaling.active_speaker.transport && roomState.media_signaling.active_speaker.transport.type === 'data-channel') {\n        this._setupDataTransportBackedDominantSpeakerSignaling(roomState.media_signaling.active_speaker.transport.label);\n      }\n\n      if (!this._networkQualityMonitorPromise && roomState.media_signaling && roomState.media_signaling.network_quality && roomState.media_signaling.network_quality.transport && roomState.media_signaling.network_quality.transport.type === 'data-channel') {\n        this._setupDataTransportBackedNetworkQualityMonitor(roomState.media_signaling.network_quality.transport.label);\n      }\n\n      if (!this._trackPriorityPromise && roomState.media_signaling && roomState.media_signaling.track_priority && roomState.media_signaling.track_priority.transport && roomState.media_signaling.track_priority.transport.type === 'data-channel') {\n        this._setupTrackPrioritySignaling(roomState.media_signaling.track_priority.transport.label);\n      }\n\n      if (!this._trackSwitchOffPromise && roomState.media_signaling && roomState.media_signaling.track_switch_off && roomState.media_signaling.track_switch_off.transport && roomState.media_signaling.track_switch_off.transport.type === 'data-channel') {\n        this._setupTrackSwitchOffMonitor(roomState.media_signaling.track_switch_off.transport.label);\n      }\n\n      return this;\n    }\n\n    // track priority signaling MSP is now used only for subscribe side priority changes.\n    // publisher side priority changes and notifications are handled by RSP.\n\n  }, {\n    key: '_setupTrackPrioritySignaling',\n    value: function _setupTrackPrioritySignaling(id) {\n      var _this4 = this;\n\n      this._teardownTrackPrioritySignaling();\n      var trackPriorityPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }if (_this4._trackPriorityPromise !== trackPriorityPromise) {\n          return;\n        }\n\n        // NOTE(mmalavalli): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and a new RTCDataChannel is created in order\n        // to resume sending Track Priority updates.\n        receiver.once('close', function () {\n          return _this4._teardownTrackPrioritySignaling();\n        });\n\n        var trackPrioritySignaling = new _this4._TrackPrioritySignaling(receiver.toDataTransport());\n        [].concat(_toConsumableArray(_this4.participants.values())).forEach(function (participant) {\n          participant.setTrackPrioritySignaling(trackPrioritySignaling);\n        });\n      });\n      this._trackPriorityPromise = trackPriorityPromise;\n    }\n  }, {\n    key: '_setupTrackSwitchOff',\n    value: function _setupTrackSwitchOff(trackSwitchOffSignaling) {\n      var _this5 = this;\n\n      this._trackSwitchOffSignaling = trackSwitchOffSignaling;\n      trackSwitchOffSignaling.on('updated', function (tracksOff, tracksOn) {\n        _this5.participants.forEach(function (participant) {\n          participant.tracks.forEach(function (track) {\n            if (tracksOff.includes(track.sid)) {\n              track.setSwitchedOff(true);\n            }\n            if (tracksOn.includes(track.sid)) {\n              track.setSwitchedOff(false);\n            }\n          });\n        });\n      });\n    }\n  }, {\n    key: '_setupTrackSwitchOffMonitor',\n    value: function _setupTrackSwitchOffMonitor(id) {\n      var _this6 = this;\n\n      this._teardownTrackSwitchOff();\n      var trackSwitchOffPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }if (_this6._trackSwitchOffPromise !== trackSwitchOffPromise) {\n          return;\n        }\n\n        // NOTE(mpatwardhan): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and a new RTCDataChannel is created in order\n        // to resume sending Dominant Speaker updates.\n        receiver.once('close', function () {\n          return _this6._teardownTrackSwitchOff();\n        });\n\n        var trackSwitchOffSignaling = new _this6._TrackSwitchOffSignaling(receiver.toDataTransport());\n        _this6._setupTrackSwitchOff(trackSwitchOffSignaling);\n      });\n      this._trackSwitchOffPromise = trackSwitchOffPromise;\n    }\n\n    /**\n     * Create a {@link DataTransport}-backed {@link DominantSpeakerSignaling}.\n     * @private\n     * @param {ID} id - ID of the {@link DataTrackReceiver} that will ultimately\n     *   be converted into a {@link DataTrackTransport} for use with\n     *   {@link DominantSpeakerSignaling}\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setupDataTransportBackedDominantSpeakerSignaling',\n    value: function _setupDataTransportBackedDominantSpeakerSignaling(id) {\n      var _this7 = this;\n\n      this._teardownDominantSpeakerSignaling();\n      var dominantSpeakerSignalingPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }if (_this7._dominantSpeakerSignalingPromise !== dominantSpeakerSignalingPromise) {\n          // NOTE(mroberts): _teardownDominantSpeakerSignaling was called.\n          return;\n        }\n\n        // NOTE(mpatwardhan): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and a new RTCDataChannel is created in order\n        // to resume sending Dominant Speaker updates.\n        receiver.once('close', function () {\n          return _this7._teardownDominantSpeakerSignaling();\n        });\n\n        var dominantSpeakerSignaling = new _this7._DominantSpeakerSignaling(receiver.toDataTransport());\n        _this7._setDominantSpeakerSignaling(dominantSpeakerSignaling);\n      });\n      this._dominantSpeakerSignalingPromise = dominantSpeakerSignalingPromise;\n    }\n    /**\n     * Create a {@link DataTransport}-backed {@link NetworkQualityMonitor}.\n     * @private\n     * @param {ID} id - ID of the {@link DataTrackReceiver} that will ultimately\n     *   be converted into a {@link DataTrackTransport} for use with\n     *   {@link NetworkQualitySignaling}\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setupDataTransportBackedNetworkQualityMonitor',\n    value: function _setupDataTransportBackedNetworkQualityMonitor(id) {\n      var _this8 = this;\n\n      var self = this;\n      this._teardownNetworkQualityMonitor();\n      var networkQualityMonitorPromise = this._getTrackReceiver(id).then(function (receiver) {\n        if (receiver.kind !== 'data') {\n          throw new Error('Expected a DataTrackReceiver');\n        }if (_this8._networkQualityMonitorPromise !== networkQualityMonitorPromise) {\n          // NOTE(mroberts): _teardownNetworkQualityMonitor was called.\n          return;\n        }\n\n        // NOTE(mpatwardhan): The underlying RTCDataChannel is closed whenever\n        // the VMS instance fails over, and new a RTCDataChannel is created in order\n        // to resume exchanging Network Quality messages.\n        receiver.once('close', function () {\n          return _this8._teardownNetworkQualityMonitor();\n        });\n\n        var networkQualitySignaling = new _this8._NetworkQualitySignaling(receiver.toDataTransport(), self._networkQualityConfiguration);\n        var networkQualityMonitor = new _this8._NetworkQualityMonitor(_this8._peerConnectionManager, networkQualitySignaling);\n        _this8._setNetworkQualityMonitor(networkQualityMonitor);\n      });\n      this._networkQualityMonitorPromise = networkQualityMonitorPromise;\n    }\n  }, {\n    key: '_setDominantSpeakerSignaling',\n    value: function _setDominantSpeakerSignaling(dominantSpeakerSignaling) {\n      var _this9 = this;\n\n      this._dominantSpeakerSignaling = dominantSpeakerSignaling;\n      dominantSpeakerSignaling.on('updated', function () {\n        return _this9.setDominantSpeaker(dominantSpeakerSignaling.loudestParticipantSid);\n      });\n    }\n  }, {\n    key: '_setNetworkQualityMonitor',\n    value: function _setNetworkQualityMonitor(networkQualityMonitor) {\n      var _this10 = this;\n\n      this._networkQualityMonitor = networkQualityMonitor;\n      networkQualityMonitor.on('updated', function () {\n        if (_this10.mediaConnectionState === 'failed') {\n          return;\n        }\n        _this10.localParticipant.setNetworkQualityLevel(networkQualityMonitor.level, networkQualityMonitor.levels);\n        _this10.participants.forEach(function (participant) {\n          var levels = networkQualityMonitor.remoteLevels.get(participant.sid);\n          if (levels) {\n            participant.setNetworkQualityLevel(levels.level, levels);\n          }\n        });\n      });\n      networkQualityMonitor.start();\n    }\n  }, {\n    key: '_teardownDominantSpeakerSignaling',\n    value: function _teardownDominantSpeakerSignaling() {\n      this._dominantSpeakerSignalingPromise = null;\n      this._dominantSpeakerSignaling = null;\n    }\n  }, {\n    key: '_teardownNetworkQualityMonitor',\n    value: function _teardownNetworkQualityMonitor() {\n      this._networkQualityMonitorPromise = null;\n      if (this._networkQualityMonitor) {\n        this._networkQualityMonitor.stop();\n        this._networkQualityMonitor = null;\n      }\n    }\n  }, {\n    key: '_teardownTrackPrioritySignaling',\n    value: function _teardownTrackPrioritySignaling() {\n      this._trackPrioritySignaling = null;\n      this._trackPriorityPromise = null;\n      this.localParticipant.setTrackPrioritySignaling(null);\n      this.participants.forEach(function (participant) {\n        participant.setTrackPrioritySignaling(null);\n      });\n    }\n  }, {\n    key: '_teardownTrackSwitchOff',\n    value: function _teardownTrackSwitchOff() {\n      this._trackSwitchOffSignaling = null;\n      this._trackSwitchOffPromise = null;\n    }\n\n    /**\n     * Get the {@link RoomV2}'s media statistics.\n     * @returns {Promise.<Map<PeerConnectionV2#id, StandardizedStatsResponse>>}\n     */\n\n  }, {\n    key: 'getStats',\n    value: function getStats() {\n      var _this11 = this;\n\n      return this._peerConnectionManager.getStats().then(function (responses) {\n        return new Map(Array.from(responses).map(function (_ref) {\n          var _ref2 = _slicedToArray(_ref, 2),\n              id = _ref2[0],\n              response = _ref2[1];\n\n          return [id, Object.assign({}, response, {\n            localAudioTrackStats: filterAndAddLocalTrackSids(_this11, response.localAudioTrackStats),\n            localVideoTrackStats: filterAndAddLocalTrackSids(_this11, response.localVideoTrackStats),\n            remoteAudioTrackStats: filterAndAddRemoteTrackSids(_this11, response.remoteAudioTrackStats),\n            remoteVideoTrackStats: filterAndAddRemoteTrackSids(_this11, response.remoteVideoTrackStats)\n          })];\n        }));\n      });\n    }\n  }, {\n    key: 'signalingConnectionState',\n    get: function get() {\n      return this._transport.state === 'syncing' ? 'reconnecting' : this._transport.state;\n    }\n\n    /**\n     * The Media Connection State\n     * @property {RTCIceConnectionState}\n     */\n\n  }, {\n    key: 'mediaConnectionState',\n    get: function get() {\n      return this._peerConnectionManager.iceConnectionState;\n    }\n  }]);\n\n  return RoomV2;\n}(RoomSignaling);\n\n/**\n * Filter out {@link TrackStats} that aren't in the collection while also\n * stamping their Track SIDs.\n * @param {Map<ID, SID>} idToSid\n * @param {Array<TrackStats>} trackStats\n * @returns {Array<TrackStats>}\n */\n\n\nfunction filterAndAddTrackSids(idToSid, trackStats) {\n  return trackStats.reduce(function (trackStats, trackStat) {\n    var trackSid = idToSid.get(trackStat.trackId);\n    return trackSid ? [Object.assign({}, trackStat, { trackSid: trackSid })].concat(trackStats) : trackStats;\n  }, []);\n}\n\n/**\n * Filter out {@link LocalTrackStats} that aren't currently published while also\n * stamping their Track SIDs.\n * @param {RoomV2} roomV2\n * @param {Array<LocalTrackStats>} localTrackStats\n * @returns {Array<LocalTrackStats>}\n */\nfunction filterAndAddLocalTrackSids(roomV2, localTrackStats) {\n  return filterAndAddTrackSids(roomV2._published, localTrackStats);\n}\n\n/**\n * Filter out {@link RemoteTrackStats} that aren't currently subscribed while\n * also stamping their Track SIDs.\n * @param {RoomV2} roomV2\n * @param {Array<RemoteTrackStats>} remoteTrackStats\n * @returns {Array<RemoteTrackStats>}\n */\nfunction filterAndAddRemoteTrackSids(roomV2, remoteTrackStats) {\n  var idToSid = new Map(Array.from(roomV2._subscribed.entries()).map(function (_ref3) {\n    var _ref4 = _slicedToArray(_ref3, 2),\n        sid = _ref4[0],\n        id = _ref4[1];\n\n    return [id, sid];\n  }));\n  return filterAndAddTrackSids(idToSid, remoteTrackStats);\n}\n\n/**\n * @typedef {object} RoomV2#Representation\n * @property {string} name\n * @property {LocalParticipantV2#Representation} participant\n * @property {?Array<RemoteParticipantV2#Representation>} participants\n * @property {?Array<PeerConnectionV2#Representation>} peer_connections\n * @property {?RecordingV2#Representation} recording\n * @property {string} sid\n */\n\nfunction handleLocalParticipantEvents(roomV2, localParticipant) {\n  var localParticipantUpdated = oncePerTick(function () {\n    roomV2._publishNewLocalParticipantState();\n  });\n\n  var renegotiate = oncePerTick(function () {\n    var trackSenders = flatMap(localParticipant.tracks, function (trackV2) {\n      return trackV2.trackTransceiver;\n    });\n    roomV2._peerConnectionManager.setTrackSenders(trackSenders);\n  });\n\n  localParticipant.on('trackAdded', renegotiate);\n  localParticipant.on('trackRemoved', renegotiate);\n  localParticipant.on('updated', localParticipantUpdated);\n\n  roomV2.on('stateChanged', function stateChanged(state) {\n    if (state === 'disconnected') {\n      localParticipant.removeListener('trackAdded', renegotiate);\n      localParticipant.removeListener('trackRemoved', renegotiate);\n      localParticipant.removeListener('updated', localParticipantUpdated);\n      roomV2.removeListener('stateChanged', stateChanged);\n      localParticipant.disconnect();\n    }\n  });\n}\n\nfunction handlePeerConnectionEvents(roomV2, peerConnectionManager) {\n  peerConnectionManager.on('description', function onDescription(description) {\n    roomV2._publishPeerConnectionState(description);\n  });\n  peerConnectionManager.dequeue('description');\n\n  peerConnectionManager.on('candidates', function onCandidates(candidates) {\n    roomV2._publishPeerConnectionState(candidates);\n  });\n  peerConnectionManager.dequeue('candidates');\n\n  peerConnectionManager.on('trackAdded', roomV2._addTrackReceiver.bind(roomV2));\n  peerConnectionManager.dequeue('trackAdded');\n  peerConnectionManager.getTrackReceivers().forEach(roomV2._addTrackReceiver, roomV2);\n\n  peerConnectionManager.on('iceConnectionStateChanged', function () {\n    roomV2.emit('mediaConnectionStateChanged');\n    if (roomV2.mediaConnectionState === 'failed') {\n      if (roomV2.localParticipant.networkQualityLevel !== null) {\n        roomV2.localParticipant.setNetworkQualityLevel(0);\n      }\n      roomV2.participants.forEach(function (participant) {\n        if (participant.networkQualityLevel !== null) {\n          participant.setNetworkQualityLevel(0);\n        }\n      });\n    }\n  });\n}\n\nfunction handleTransportEvents(roomV2, transport) {\n  transport.on('message', roomV2._update.bind(roomV2));\n  transport.on('stateChanged', function stateChanged(state, error) {\n    if (state === 'disconnected') {\n      if (roomV2.state !== 'disconnected') {\n        roomV2._disconnect(error);\n      }\n      transport.removeListener('stateChanged', stateChanged);\n    }\n    roomV2.emit('signalingConnectionStateChanged');\n  });\n}\n\n/**\n * Periodically publish {@link StatsReport}s.\n * @private\n * @param {RoomV2} roomV2\n * @param {Transport} transport\n * @param {Number} intervalMs\n */\nfunction periodicallyPublishStats(roomV2, transport, intervalMs) {\n  var interval = setInterval(function () {\n    roomV2.getStats().then(function (stats) {\n      stats.forEach(function (response, id) {\n        // NOTE(mmalavalli): A StatsReport is used to publish a \"stats-report\"\n        // event instead of using StandardizedStatsResponse directly because\n        // StatsReport will add nulls to properties that do not exist.\n        var report = new StatsReport(id, response);\n\n        transport.publishEvent('quality', 'stats-report', {\n          audioTrackStats: report.remoteAudioTrackStats,\n          localAudioTrackStats: report.localAudioTrackStats,\n          localVideoTrackStats: report.localVideoTrackStats,\n          peerConnectionId: report.peerConnectionId,\n          videoTrackStats: report.remoteVideoTrackStats\n        });\n\n        // NOTE(mmalavalli): null properties of the \"active-ice-candidate-pair\"\n        // payload are assigned default values until the Insights gateway\n        // accepts null values.\n        var activeIceCandidatePair = replaceNullsWithDefaults(response.activeIceCandidatePair, report.peerConnectionId);\n\n        transport.publishEvent('quality', 'active-ice-candidate-pair', activeIceCandidatePair);\n      });\n    }, function () {\n      // Do nothing.\n    });\n  }, intervalMs);\n\n  roomV2.on('stateChanged', function onStateChanged(state) {\n    if (state === 'disconnected') {\n      clearInterval(interval);\n      roomV2.removeListener('stateChanged', onStateChanged);\n    }\n  });\n}\n\nfunction handleSubscriptions(room) {\n  var trackSidsToTrackSignalings = room._getTrackSidsToTrackSignalings();\n\n  room._subscriptionFailures.forEach(function (error, trackSid) {\n    var trackSignaling = trackSidsToTrackSignalings.get(trackSid);\n    if (trackSignaling) {\n      room._subscriptionFailures.delete(trackSid);\n      trackSignaling.subscribeFailed(createTwilioError(error.code, error.message));\n    }\n  });\n\n  trackSidsToTrackSignalings.forEach(function (trackSignaling) {\n    var trackId = room._subscribed.get(trackSignaling.sid);\n    if (!trackId || trackSignaling.isSubscribed && trackSignaling.trackTransceiver.id !== trackId) {\n      trackSignaling.setTrackTransceiver(null);\n    }\n    if (trackId) {\n      room._getTrackReceiver(trackId).then(function (trackReceiver) {\n        return trackSignaling.setTrackTransceiver(trackReceiver);\n      });\n    }\n  });\n}\n\nfunction replaceNullsWithDefaults(activeIceCandidatePair, peerConnectionId) {\n  activeIceCandidatePair = Object.assign({\n    availableIncomingBitrate: 0,\n    availableOutgoingBitrate: 0,\n    bytesReceived: 0,\n    bytesSent: 0,\n    consentRequestsSent: 0,\n    currentRoundTripTime: 0,\n    lastPacketReceivedTimestamp: 0,\n    lastPacketSentTimestamp: 0,\n    nominated: false,\n    peerConnectionId: peerConnectionId,\n    priority: 0,\n    readable: false,\n    requestsReceived: 0,\n    requestsSent: 0,\n    responsesReceived: 0,\n    responsesSent: 0,\n    retransmissionsReceived: 0,\n    retransmissionsSent: 0,\n    state: 'failed',\n    totalRoundTripTime: 0,\n    transportId: '',\n    writable: false\n  }, filterObject(activeIceCandidatePair || {}, null));\n\n  activeIceCandidatePair.localCandidate = Object.assign({\n    candidateType: 'host',\n    deleted: false,\n    ip: '',\n    port: 0,\n    priority: 0,\n    protocol: 'udp',\n    relayProtocol: 'udp',\n    url: ''\n  }, filterObject(activeIceCandidatePair.localCandidate || {}, null));\n\n  activeIceCandidatePair.remoteCandidate = Object.assign({\n    candidateType: 'host',\n    ip: '',\n    port: 0,\n    priority: 0,\n    protocol: 'udp',\n    url: ''\n  }, filterObject(activeIceCandidatePair.remoteCandidate || {}, null));\n\n  return activeIceCandidatePair;\n}\n\nmodule.exports = RoomV2;"]},"metadata":{},"sourceType":"script"}